<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¯†ç æŸ¥çœ‹åŠŸèƒ½è°ƒè¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .section { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; }
        .success { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; background: #3b82f6; color: white; border: none; border-radius: 4px; }
        button:hover { background: #2563eb; }
        pre { background: #f1f5f9; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .step { margin: 10px 0; padding: 10px; background: #f8fafc; border-left: 3px solid #3b82f6; }
    </style>
</head>
<body>
    <h1>ğŸ” å¯†ç æŸ¥çœ‹åŠŸèƒ½è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>æ­¥éª¤ 1: æ£€æŸ¥ç¯å¢ƒ</h2>
        <button onclick="checkEnvironment()">è¿è¡Œç¯å¢ƒæ£€æŸ¥</button>
        <div id="env-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤ 2: æ£€æŸ¥ Storage</h2>
        <button onclick="checkStorage()">æ£€æŸ¥å­˜å‚¨çŠ¶æ€</button>
        <button onclick="clearStorage()">æ¸…é™¤æ‰€æœ‰å­˜å‚¨</button>
        <div id="storage-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤ 3: æµ‹è¯• REVEAL_KEY ç”Ÿæˆ</h2>
        <button onclick="testRevealKey()">æµ‹è¯•å¯†é’¥ç”Ÿæˆ</button>
        <button onclick="showRevealKey()">æ˜¾ç¤ºå½“å‰å¯†é’¥</button>
        <div id="reveal-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤ 4: æµ‹è¯•åŠ å¯†è§£å¯†</h2>
        <button onclick="testCrypto()">æµ‹è¯•åŠ å¯†åŠŸèƒ½</button>
        <div id="crypto-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤ 5: æ¨¡æ‹Ÿ API è¯·æ±‚</h2>
        <button onclick="testApiRequest()">æµ‹è¯•æŸ¥çœ‹å¯†ç è¯·æ±‚</button>
        <div id="api-result"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function checkEnvironment() {
            const result = document.getElementById('env-result');
            result.innerHTML = '<h3>ç¯å¢ƒæ£€æŸ¥ç»“æœ:</h3>';
            
            // æ£€æŸ¥æµè§ˆå™¨
            log('env-result', `âœ… æµè§ˆå™¨: ${navigator.userAgent}`, 'info');
            
            // æ£€æŸ¥ Web Crypto API
            if (window.crypto && window.crypto.subtle) {
                log('env-result', 'âœ… Web Crypto API: æ”¯æŒ', 'success');
            } else {
                log('env-result', 'âŒ Web Crypto API: ä¸æ”¯æŒ', 'error');
            }
            
            // æ£€æŸ¥ Storage
            try {
                localStorage.setItem('test', 'ok');
                localStorage.removeItem('test');
                log('env-result', 'âœ… localStorage: å¯ç”¨', 'success');
            } catch (e) {
                log('env-result', `âŒ localStorage: ä¸å¯ç”¨ - ${e.message}`, 'error');
            }
            
            try {
                sessionStorage.setItem('test', 'ok');
                sessionStorage.removeItem('test');
                log('env-result', 'âœ… sessionStorage: å¯ç”¨', 'success');
            } catch (e) {
                log('env-result', `âŒ sessionStorage: ä¸å¯ç”¨ - ${e.message}`, 'error');
            }
            
            // æ£€æŸ¥å½“å‰é¡µé¢åè®®
            log('env-result', `ğŸ“ å½“å‰åè®®: ${window.location.protocol}`, 'info');
            log('env-result', `ğŸ“ å½“å‰åŸŸå: ${window.location.host}`, 'info');
        }

        function checkStorage() {
            const result = document.getElementById('storage-result');
            result.innerHTML = '<h3>å­˜å‚¨å†…å®¹:</h3>';
            
            // localStorage
            result.innerHTML += '<h4>localStorage:</h4><pre>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                result.innerHTML += `${key}: ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}\n`;
            }
            result.innerHTML += '</pre>';
            
            // sessionStorage
            result.innerHTML += '<h4>sessionStorage:</h4><pre>';
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                const value = sessionStorage.getItem(key);
                result.innerHTML += `${key}: ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}\n`;
            }
            result.innerHTML += '</pre>';
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('storage-result', 'ğŸ—‘ï¸ æ‰€æœ‰å­˜å‚¨å·²æ¸…é™¤', 'warning');
            checkStorage();
        }

        function bytesToB64(buf) {
            const u8 = new Uint8Array(buf);
            let s = '';
            for (let i = 0; i < u8.length; i++) s += String.fromCharCode(u8[i]);
            return btoa(s);
        }

        function testRevealKey() {
            const result = document.getElementById('reveal-result');
            result.innerHTML = '<h3>å¯†é’¥ç”Ÿæˆæµ‹è¯•:</h3>';
            
            try {
                // ç”Ÿæˆå¯†é’¥
                const randomBytes = crypto.getRandomValues(new Uint8Array(32));
                const key = bytesToB64(randomBytes.buffer);
                
                log('reveal-result', `âœ… æˆåŠŸç”Ÿæˆ32å­—èŠ‚éšæœºå¯†é’¥`, 'success');
                log('reveal-result', `ğŸ“ å¯†é’¥é•¿åº¦: ${key.length} å­—ç¬¦`, 'info');
                log('reveal-result', `ğŸ”‘ å¯†é’¥é¢„è§ˆ: ${key.substring(0, 20)}...`, 'info');
                
                // ä¿å­˜åˆ° sessionStorage
                sessionStorage.setItem('infravault_reveal_key', key);
                log('reveal-result', 'âœ… å¯†é’¥å·²ä¿å­˜åˆ° sessionStorage', 'success');
                
                // éªŒè¯è¯»å–
                const savedKey = sessionStorage.getItem('infravault_reveal_key');
                if (savedKey === key) {
                    log('reveal-result', 'âœ… å¯†é’¥è¯»å–éªŒè¯æˆåŠŸ', 'success');
                } else {
                    log('reveal-result', 'âŒ å¯†é’¥è¯»å–éªŒè¯å¤±è´¥', 'error');
                }
            } catch (e) {
                log('reveal-result', `âŒ é”™è¯¯: ${e.message}`, 'error');
                console.error(e);
            }
        }

        function showRevealKey() {
            const result = document.getElementById('reveal-result');
            const key = sessionStorage.getItem('infravault_reveal_key');
            
            if (key) {
                result.innerHTML += `<h3>å½“å‰å¯†é’¥:</h3><pre>${key}</pre>`;
                result.innerHTML += `<div class="success">âœ… å¯†é’¥å­˜åœ¨ (${key.length} å­—ç¬¦)</div>`;
            } else {
                result.innerHTML += `<div class="error">âŒ æ²¡æœ‰æ‰¾åˆ°å¯†é’¥</div>`;
            }
        }

        async function testCrypto() {
            const result = document.getElementById('crypto-result');
            result.innerHTML = '<h3>åŠ å¯†è§£å¯†æµ‹è¯•:</h3>';
            
            try {
                // æµ‹è¯•æ•°æ®
                const plaintext = 'test_password_123';
                log('crypto-result', `ğŸ“ åŸå§‹æ•°æ®: ${plaintext}`, 'info');
                
                // ç”Ÿæˆå¯†é’¥
                const keyBytes = crypto.getRandomValues(new Uint8Array(32));
                const keyB64 = bytesToB64(keyBytes.buffer);
                log('crypto-result', `ğŸ”‘ ç”Ÿæˆå¯†é’¥: ${keyB64.substring(0, 20)}...`, 'info');
                
                // åŠ å¯†
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    keyBytes,
                    { name: 'AES-GCM' },
                    false,
                    ['encrypt']
                );
                
                const encoder = new TextEncoder();
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    keyMaterial,
                    encoder.encode(plaintext)
                );
                
                log('crypto-result', 'âœ… åŠ å¯†æˆåŠŸ', 'success');
                
                // è§£å¯†
                const decryptKey = await crypto.subtle.importKey(
                    'raw',
                    keyBytes,
                    { name: 'AES-GCM' },
                    false,
                    ['decrypt']
                );
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv },
                    decryptKey,
                    encrypted
                );
                
                const decoder = new TextDecoder();
                const decryptedText = decoder.decode(decrypted);
                
                if (decryptedText === plaintext) {
                    log('crypto-result', `âœ… è§£å¯†æˆåŠŸ: ${decryptedText}`, 'success');
                } else {
                    log('crypto-result', `âŒ è§£å¯†å¤±è´¥: æœŸæœ› "${plaintext}", å¾—åˆ° "${decryptedText}"`, 'error');
                }
                
            } catch (e) {
                log('crypto-result', `âŒ é”™è¯¯: ${e.message}`, 'error');
                console.error(e);
            }
        }

        async function testApiRequest() {
            const result = document.getElementById('api-result');
            result.innerHTML = '<h3>API è¯·æ±‚æµ‹è¯•:</h3>';
            
            try {
                // æ£€æŸ¥ token
                const token = localStorage.getItem('infravault_token');
                if (!token) {
                    log('api-result', 'âš ï¸ æœªæ‰¾åˆ°ç™»å½• tokenï¼Œè¯·å…ˆç™»å½•ä¸»åº”ç”¨', 'warning');
                    return;
                }
                log('api-result', `âœ… Token å­˜åœ¨ (${token.length} å­—ç¬¦)`, 'success');
                
                // æ£€æŸ¥æˆ–ç”Ÿæˆ reveal key
                let revealKey = sessionStorage.getItem('infravault_reveal_key');
                if (!revealKey) {
                    const keyBytes = crypto.getRandomValues(new Uint8Array(32));
                    revealKey = bytesToB64(keyBytes.buffer);
                    sessionStorage.setItem('infravault_reveal_key', revealKey);
                    log('api-result', 'ğŸ”‘ ç”Ÿæˆæ–°çš„ reveal key', 'info');
                } else {
                    log('api-result', 'ğŸ”‘ ä½¿ç”¨å·²æœ‰ reveal key', 'info');
                }
                
                // æµ‹è¯• API
                const BASE = 'http://localhost:4000/api/v1';
                log('api-result', `ğŸ“¡ è¯·æ±‚åœ°å€: ${BASE}/me`, 'info');
                
                const response = await fetch(`${BASE}/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('api-result', `ğŸ“¡ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('api-result', `âœ… API è¿æ¥æ­£å¸¸`, 'success');
                    log('api-result', `ğŸ‘¤ ç”¨æˆ·: ${data.user?.username || 'æœªçŸ¥'}`, 'info');
                } else {
                    log('api-result', `âŒ API è¯·æ±‚å¤±è´¥`, 'error');
                }
                
            } catch (e) {
                log('api-result', `âŒ é”™è¯¯: ${e.message}`, 'error');
                console.error(e);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºæœ¬æ£€æŸ¥
        window.onload = function() {
            console.log('ğŸ” è°ƒè¯•å·¥å…·å·²åŠ è½½');
            console.log('æç¤ºï¼šè¯·æŒ‰é¡ºåºç‚¹å‡»å„ä¸ªæŒ‰é’®è¿›è¡Œæ£€æŸ¥');
        };
    </script>
</body>
</html>

