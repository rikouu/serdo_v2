# ðŸ”§ ä¼šè¯æŒä¹…åŒ–ä¿®å¤è¯´æ˜Ž

## é—®é¢˜æè¿°

**ç—‡çŠ¶**: ç”¨æˆ·ç™»å½•åŽï¼ŒæŒ‰ F5 åˆ·æ–°é¡µé¢ä¼šè‡ªåŠ¨é€€å‡ºç™»å½•

**åŽŸå› **: 
1. åˆ·æ–°æ—¶æ²¡æœ‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¿å­˜çš„ token
2. ç½‘ç»œé”™è¯¯æ—¶é”™è¯¯åœ°åˆ é™¤äº† token
3. ç™»å‡ºæ—¶æ²¡æœ‰æ­£ç¡®æ¸…ç† token å’Œè§£å¯†å¯†é’¥

---

## ä¿®å¤å†…å®¹

### 1. æ”¹è¿›ä¼šè¯æ¢å¤é€»è¾‘ (`App.tsx`)

**ä¿®å¤å‰**:
- åˆ·æ–°æ—¶ç›´æŽ¥è°ƒç”¨ APIï¼Œä¸æ£€æŸ¥ token æ˜¯å¦å­˜åœ¨
- ä»»ä½•é”™è¯¯éƒ½ä¼šå¯¼è‡´ç”¨æˆ·çŠ¶æ€ä¸º nullï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢

**ä¿®å¤åŽ**:
```typescript
// 1. æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ token
const savedToken = localStorage.getItem('infravault_token');
if (!savedToken) {
  setIsAuthChecking(false);
  return;
}

// 2. å°è¯•æ¢å¤ä¼šè¯
try {
  const me = await getMeApi();
  if (me && me.user) {
    setCurrentUser(me.user);
  }
} catch (error) {
  // ç½‘ç»œé”™è¯¯ä¸å½±å“ï¼Œtoken ä¿ç•™
  console.error('Session restore failed:', error?.message);
}
```

### 2. æ”¹è¿› API é”™è¯¯å¤„ç† (`services/apiClient.ts`)

**ä¿®å¤å‰**:
- æ‰€æœ‰ 401 é”™è¯¯éƒ½åˆ é™¤ token
- ç½‘ç»œé”™è¯¯æœªåŒºåˆ†å¤„ç†

**ä¿®å¤åŽ**:
```typescript
try {
  const res = await fetch(`${BASE}${path}`, init)
  // ... å¤„ç†å“åº”
} catch (error) {
  // ç½‘ç»œé”™è¯¯ä¸åˆ é™¤ tokenï¼Œè®©ç”¨æˆ·å¯ä»¥é‡è¯•
  if (error.name === 'TypeError' && error.message.includes('fetch')) {
    throw new Error('network_error')
  }
  throw error
}
```

### 3. æ·»åŠ æ­£ç¡®çš„ç™»å‡ºå‡½æ•°

**æ–°å¢žåŠŸèƒ½**:
```typescript
export const logoutUserApi = () => {
  try {
    localStorage.removeItem(TOKEN_KEY)
    REVEAL_KEY = null // æ¸…é™¤è§£å¯†å¯†é’¥
  } catch (error) {
    console.error('Logout error:', error)
  }
}
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: æ­£å¸¸åˆ·æ–°
1. ç™»å½•ç³»ç»Ÿ
2. æŒ‰ F5 åˆ·æ–°é¡µé¢
3. **é¢„æœŸ**: è‡ªåŠ¨æ¢å¤ç™»å½•çŠ¶æ€ âœ…

### æµ‹è¯•åœºæ™¯ 2: Token è¿‡æœŸ
1. ç™»å½•ç³»ç»Ÿ
2. ç­‰å¾… token è¿‡æœŸï¼ˆ7å¤©ï¼‰æˆ–æ‰‹åŠ¨ä¿®æ”¹ token
3. åˆ·æ–°é¡µé¢
4. **é¢„æœŸ**: æ˜¾ç¤ºç™»å½•é¡µé¢ï¼ˆtoken è¢«æ¸…é™¤ï¼‰ âœ…

### æµ‹è¯•åœºæ™¯ 3: ç½‘ç»œé”™è¯¯
1. ç™»å½•ç³»ç»Ÿ
2. åœæ­¢åŽç«¯æœåŠ¡
3. åˆ·æ–°é¡µé¢
4. **é¢„æœŸ**: 
   - æ˜¾ç¤ºåŠ è½½ç•Œé¢
   - åŠ è½½å¤±è´¥åŽæ˜¾ç¤ºç™»å½•é¡µé¢
   - Token ä¿ç•™åœ¨ localStorage
   - é‡å¯åŽç«¯åŽå¯ä»¥æ¢å¤

### æµ‹è¯•åœºæ™¯ 4: æ­£å¸¸ç™»å‡º
1. ç™»å½•ç³»ç»Ÿ
2. ç‚¹å‡»ç™»å‡ºæŒ‰é’®
3. **é¢„æœŸ**: 
   - Token è¢«æ¸…é™¤
   - REVEAL_KEY è¢«æ¸…é™¤
   - è¿”å›žç™»å½•é¡µé¢ âœ…

---

## æŠ€æœ¯ç»†èŠ‚

### Token å­˜å‚¨ç­–ç•¥

```typescript
// Token é”®å
const TOKEN_KEY = 'infravault_token'

// å­˜å‚¨ (ç™»å½•æ—¶)
localStorage.setItem(TOKEN_KEY, data.token)

// è¯»å– (æ¯æ¬¡ API è¯·æ±‚)
const token = localStorage.getItem(TOKEN_KEY)

// åˆ é™¤ (ç™»å‡ºæˆ– 401 é”™è¯¯)
localStorage.removeItem(TOKEN_KEY)
```

### ä¼šè¯æ¢å¤æµç¨‹

```
é¡µé¢åŠ è½½
  â†“
æ£€æŸ¥ VITE_USE_API
  â†“
æ£€æŸ¥ localStorage ä¸­çš„ token
  â†“
æœ‰ token â†’ è°ƒç”¨ /api/v1/me
  â†“
æˆåŠŸ â†’ æ¢å¤ç”¨æˆ·çŠ¶æ€
å¤±è´¥ â†’ ä¿æŒç™»å½•é¡µé¢ï¼ˆ401æ—¶tokenå·²è¢«æ¸…é™¤ï¼‰
  â†“
æ—  token â†’ ç›´æŽ¥æ˜¾ç¤ºç™»å½•é¡µé¢
```

### é”™è¯¯å¤„ç†ç­–ç•¥

| é”™è¯¯ç±»åž‹ | æ“ä½œ | åŽŸå›  |
|---------|------|------|
| 401 æœªæŽˆæƒ | åˆ é™¤ token | Token æ— æ•ˆæˆ–è¿‡æœŸ |
| ç½‘ç»œé”™è¯¯ | ä¿ç•™ token | å¯èƒ½æ˜¯ä¸´æ—¶ç½‘ç»œé—®é¢˜ |
| å…¶ä»–é”™è¯¯ | ä¿ç•™ token | å¯èƒ½æ˜¯æœåŠ¡å™¨é—®é¢˜ |

---

## å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶
1. `App.tsx` - ä¼šè¯æ¢å¤é€»è¾‘
2. `services/apiClient.ts` - API é”™è¯¯å¤„ç†å’Œç™»å‡ºå‡½æ•°

### å½±å“çš„åŠŸèƒ½
- âœ… ç”¨æˆ·ç™»å½•/ç™»å‡º
- âœ… é¡µé¢åˆ·æ–°åŽçŠ¶æ€ä¿æŒ
- âœ… Token è¿‡æœŸå¤„ç†
- âœ… ç½‘ç»œé”™è¯¯å®¹é”™

### å‘åŽå…¼å®¹æ€§
- âœ… å®Œå…¨å…¼å®¹çŽ°æœ‰ä»£ç 
- âœ… ä¸å½±å“æœ¬åœ°å­˜å‚¨æ¨¡å¼ (VITE_USE_API=false)
- âœ… ä¸å½±å“çŽ°æœ‰ API è°ƒç”¨

---

## æœ€ä½³å®žè·µå»ºè®®

### 1. Token ç”Ÿå‘½å‘¨æœŸç®¡ç†
```typescript
// å½“å‰: 7å¤©è¿‡æœŸ
const expSeconds = 7 * 24 * 3600

// å»ºè®®: æ ¹æ®å®‰å…¨éœ€æ±‚è°ƒæ•´
// é«˜å®‰å…¨: 1å°æ—¶ + åˆ·æ–°tokenæœºåˆ¶
// ä¸­å®‰å…¨: 1å¤©
// ä½Žå®‰å…¨: 7å¤©
```

### 2. é”™è¯¯æç¤ºä¼˜åŒ–
```typescript
// å»ºè®®æ·»åŠ ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
if (error.message === 'network_error') {
  showNotification('ç½‘ç»œè¿žæŽ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåŽé‡è¯•')
}
```

### 3. è‡ªåŠ¨é‡è¯•æœºåˆ¶
```typescript
// å¯é€‰: æ·»åŠ è‡ªåŠ¨é‡è¯•é€»è¾‘
const retryApi = async (fn, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn()
    } catch (error) {
      if (i === maxRetries - 1) throw error
      await delay(1000 * (i + 1))
    }
  }
}
```

---

## ç›¸å…³æ–‡æ¡£

- [JWT è®¤è¯æœºåˆ¶](./api/auth.js)
- [API å®¢æˆ·ç«¯](./services/apiClient.ts)
- [é”™è¯¯å¤„ç†](./PRODUCTION_CHECKLIST.md#é”™è¯¯å¤„ç†ä¸Žæ—¥å¿—)

---

**ä¿®å¤æ—¶é—´**: 2024-12-05
**ç‰ˆæœ¬**: 1.0.1
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•

