<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•å¯†ç è§£å¯†</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .section { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        pre { background: #f1f5f9; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª æµ‹è¯•å¯†ç è§£å¯†åŠŸèƒ½</h1>
    
    <div class="section">
        <h2>æ­¥éª¤ 1: ç™»å½•å¹¶è·å–token</h2>
        <button onclick="login()">ç‚¹å‡»ç™»å½•</button>
        <div id="login-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤ 2: è·å–åŠ å¯†çš„ Bark Key</h2>
        <button onclick="fetchBarkKey()">è·å– Bark Key</button>
        <div id="bark-result"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤ 3: è§£å¯†å¹¶æ˜¾ç¤º</h2>
        <button onclick="decryptAndShow()">è§£å¯†å¯†ç </button>
        <div id="decrypt-result"></div>
    </div>

    <script>
        let token = '';
        let revealKey = '';
        let encryptedData = null;

        function log(id, msg, type = 'info') {
            const el = document.getElementById(id);
            const color = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            el.innerHTML += `<div class="${color}">${msg}</div>`;
        }

        function bytesToB64(buf) {
            const u8 = new Uint8Array(buf);
            let s = '';
            for (let i = 0; i < u8.length; i++) s += String.fromCharCode(u8[i]);
            return btoa(s);
        }

        function b64ToBytes(b64) {
            return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
        }

        async function aesGcmDecrypt(keyB64, ivB64, tagB64, dataB64) {
            const keyRaw = b64ToBytes(keyB64);
            const iv = b64ToBytes(ivB64);
            const tag = b64ToBytes(tagB64);
            const data = b64ToBytes(dataB64);
            
            const combined = new Uint8Array(data.length + tag.length);
            combined.set(data);
            combined.set(tag, data.length);
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyRaw,
                { name: 'AES-GCM' },
                false,
                ['decrypt']
            );
            
            const pt = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv },
                cryptoKey,
                combined
            );
            
            const u8 = new Uint8Array(pt);
            let s = '';
            for (let i = 0; i < u8.length; i++) s += String.fromCharCode(u8[i]);
            return s;
        }

        async function login() {
            const result = document.getElementById('login-result');
            result.innerHTML = '';
            
            try {
                log('login-result', 'æ­£åœ¨ç™»å½•...', 'info');
                const res = await fetch('http://localhost:4000/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin' })
                });
                
                const data = await res.json();
                token = data.token;
                
                log('login-result', 'âœ… ç™»å½•æˆåŠŸ', 'success');
                log('login-result', `Token: ${token.substring(0, 20)}...`, 'info');
                
                // ç”Ÿæˆ reveal key
                const keyBytes = crypto.getRandomValues(new Uint8Array(32));
                revealKey = bytesToB64(keyBytes.buffer);
                log('login-result', `ğŸ”‘ ç”Ÿæˆ Reveal Key: ${revealKey.substring(0, 20)}...`, 'info');
                
            } catch (e) {
                log('login-result', `âŒ é”™è¯¯: ${e.message}`, 'error');
            }
        }

        async function fetchBarkKey() {
            if (!token) {
                alert('è¯·å…ˆç™»å½•ï¼');
                return;
            }
            
            const result = document.getElementById('bark-result');
            result.innerHTML = '';
            
            try {
                log('bark-result', 'æ­£åœ¨è·å– Bark Key...', 'info');
                const res = await fetch('http://localhost:4000/api/v1/reveal/settings/bark-key', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'x-reveal-key': revealKey
                    }
                });
                
                encryptedData = await res.json();
                log('bark-result', 'âœ… è·å–æˆåŠŸ', 'success');
                log('bark-result', `<pre>${JSON.stringify(encryptedData, null, 2)}</pre>`, 'info');
                
            } catch (e) {
                log('bark-result', `âŒ é”™è¯¯: ${e.message}`, 'error');
            }
        }

        async function decryptAndShow() {
            if (!encryptedData || !encryptedData.barkKey) {
                alert('è¯·å…ˆè·å–åŠ å¯†æ•°æ®ï¼');
                return;
            }
            
            const result = document.getElementById('decrypt-result');
            result.innerHTML = '';
            
            try {
                log('decrypt-result', 'æ­£åœ¨è§£å¯†...', 'info');
                
                const { iv, tag, data } = encryptedData.barkKey;
                const decrypted = await aesGcmDecrypt(revealKey, iv, tag, data);
                
                log('decrypt-result', 'âœ… è§£å¯†æˆåŠŸï¼', 'success');
                log('decrypt-result', `<h3>ğŸ”“ Bark Key:</h3><pre style="background: #dcfce7; color: #166534; font-size: 16px; padding: 20px;">${decrypted || '(ç©º)'}</pre>`, 'success');
                
            } catch (e) {
                log('decrypt-result', `âŒ è§£å¯†å¤±è´¥: ${e.message}`, 'error');
                console.error(e);
            }
        }
    </script>
</body>
</html>

