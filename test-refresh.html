<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ·æ–°æµ‹è¯•</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f8fafc;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 { color: #1e293b; margin-bottom: 12px; }
        h2 { color: #475569; font-size: 18px; margin-bottom: 16px; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover { background: #2563eb; }
        button.success { background: #10b981; }
        button.danger { background: #ef4444; }
        .status {
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            line-height: 1.6;
        }
        .success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-error { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <h1>ğŸ”„ ä¼šè¯åˆ·æ–°æµ‹è¯•å·¥å…·</h1>
    
    <div class="card">
        <h2>å½“å‰çŠ¶æ€</h2>
        <div id="currentStatus"></div>
        <button onclick="checkAll()" style="margin-top: 12px;">ğŸ” å…¨é¢æ£€æŸ¥</button>
    </div>

    <div class="card">
        <h2>å¿«é€Ÿæµ‹è¯•æµç¨‹</h2>
        <button onclick="step1()">1ï¸âƒ£ ç™»å½•</button>
        <button onclick="step2()">2ï¸âƒ£ æ£€æŸ¥Token</button>
        <button onclick="step3()">3ï¸âƒ£ æ¨¡æ‹Ÿåˆ·æ–°</button>
        <button onclick="clearAll()" class="danger">ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</button>
        <div id="testStatus"></div>
    </div>

    <div class="card">
        <h2>è¯¦ç»†è¯Šæ–­</h2>
        <div id="diagnostic"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000/api/v1';
        const TOKEN_KEY = 'infravault_token';

        // æ£€æŸ¥æ‰€æœ‰çŠ¶æ€
        function checkAll() {
            const status = document.getElementById('currentStatus');
            const token = localStorage.getItem(TOKEN_KEY);
            
            let html = '<div style="margin-bottom: 16px;">';
            
            // æ£€æŸ¥ Token
            if (token) {
                html += '<span class="badge badge-success">âœ… Token å­˜åœ¨</span>';
                html += `<span style="color: #64748b; font-size: 13px;">é•¿åº¦: ${token.length}</span><br>`;
            } else {
                html += '<span class="badge badge-error">âŒ Token ä¸å­˜åœ¨</span><br>';
            }
            
            html += '</div>';
            
            // ç¯å¢ƒæ£€æŸ¥
            html += '<div style="background: #f1f5f9; padding: 12px; border-radius: 6px; font-size: 13px;">';
            html += '<strong>ç¯å¢ƒä¿¡æ¯:</strong><br>';
            html += `æµè§ˆå™¨: ${navigator.userAgent.split(' ').pop()}<br>`;
            html += `å½“å‰åŸŸ: ${window.location.origin}<br>`;
            html += `APIåœ°å€: ${API_BASE}<br>`;
            html += '</div>';
            
            status.innerHTML = html;
        }

        // æ­¥éª¤1: ç™»å½•
        async function step1() {
            const status = document.getElementById('testStatus');
            status.innerHTML = '<div class="status info">â³ æ­£åœ¨ç™»å½•...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin' })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    localStorage.setItem(TOKEN_KEY, data.token);
                    status.innerHTML = `
                        <div class="status success">
                            âœ… <strong>ç™»å½•æˆåŠŸï¼</strong><br>
                            ç”¨æˆ·: ${data.user.username}<br>
                            Tokenå·²ä¿å­˜åˆ° localStorage
                        </div>
                    `;
                    checkAll();
                } else {
                    status.innerHTML = `<div class="status error">âŒ ç™»å½•å¤±è´¥: ${JSON.stringify(data)}</div>`;
                }
            } catch (error) {
                status.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}<br>è¯·ç¡®è®¤åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:4000</div>`;
            }
        }

        // æ­¥éª¤2: æ£€æŸ¥Token
        function step2() {
            const status = document.getElementById('testStatus');
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (token) {
                status.innerHTML = `
                    <div class="status success">
                        âœ… <strong>Tokenæ£€æŸ¥é€šè¿‡</strong><br>
                        Tokené•¿åº¦: ${token.length} å­—ç¬¦<br>
                        Tokenå‰ç¼€: ${token.substring(0, 30)}...<br>
                        <small style="color: #64748b;">ç°åœ¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢æˆ–è°ƒç”¨ /me æ¥å£</small>
                    </div>
                `;
            } else {
                status.innerHTML = `
                    <div class="status error">
                        âŒ <strong>Tokenä¸å­˜åœ¨</strong><br>
                        è¯·å…ˆç‚¹å‡»"1ï¸âƒ£ ç™»å½•"
                    </div>
                `;
            }
            checkAll();
        }

        // æ­¥éª¤3: æ¨¡æ‹Ÿåˆ·æ–°ï¼ˆè°ƒç”¨ /me æ¥å£ï¼‰
        async function step3() {
            const status = document.getElementById('testStatus');
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (!token) {
                status.innerHTML = '<div class="status error">âŒ æ²¡æœ‰Tokenï¼Œè¯·å…ˆç™»å½•</div>';
                return;
            }
            
            status.innerHTML = '<div class="status info">â³ æ­£åœ¨è°ƒç”¨ /me æ¥å£ï¼ˆæ¨¡æ‹Ÿåˆ·æ–°ï¼‰...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    status.innerHTML = `
                        <div class="status success">
                            âœ… <strong>ä¼šè¯æ¢å¤æˆåŠŸï¼</strong><br>
                            ç”¨æˆ·ID: ${data.userId}<br>
                            ç”¨æˆ·å: ${data.user.username}<br>
                            è§’è‰²: ${data.user.role}<br>
                            <br>
                            <strong>ç»“è®º: åˆ·æ–°åŠŸèƒ½æ­£å¸¸ï¼âœ¨</strong><br>
                            <small>è¿™æ„å‘³ç€åœ¨å®é™…åº”ç”¨ä¸­æŒ‰F5åˆ·æ–°ä¼šè‡ªåŠ¨ä¿æŒç™»å½•çŠ¶æ€</small>
                        </div>
                    `;
                } else {
                    const data = await response.json();
                    status.innerHTML = `
                        <div class="status error">
                            âŒ <strong>ä¼šè¯æ¢å¤å¤±è´¥</strong><br>
                            çŠ¶æ€ç : ${response.status}<br>
                            é”™è¯¯: ${JSON.stringify(data)}<br>
                            <br>
                            ${response.status === 401 ? 'âš ï¸ Tokenå·²å¤±æ•ˆï¼Œå·²è‡ªåŠ¨æ¸…é™¤' : ''}
                        </div>
                    `;
                    if (response.status === 401) {
                        localStorage.removeItem(TOKEN_KEY);
                        checkAll();
                    }
                }
            } catch (error) {
                status.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
                localStorage.removeItem(TOKEN_KEY);
                document.getElementById('testStatus').innerHTML = '<div class="status info">âœ… æ•°æ®å·²æ¸…é™¤</div>';
                checkAll();
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = () => {
            checkAll();
            
            // æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
            const diagnostic = document.getElementById('diagnostic');
            diagnostic.innerHTML = `
                <div class="status info">
                    <strong>ğŸ“– ä½¿ç”¨è¯´æ˜ï¼š</strong><br><br>
                    <strong>1ï¸âƒ£ ç™»å½•</strong> - ä½¿ç”¨ admin/admin ç™»å½•å¹¶ä¿å­˜ Token<br>
                    <strong>2ï¸âƒ£ æ£€æŸ¥Token</strong> - éªŒè¯ Token æ˜¯å¦æ­£ç¡®ä¿å­˜<br>
                    <strong>3ï¸âƒ£ æ¨¡æ‹Ÿåˆ·æ–°</strong> - è°ƒç”¨ /me æ¥å£æµ‹è¯•ä¼šè¯æ¢å¤<br><br>
                    
                    <strong>ğŸ¯ æµ‹è¯•ç›®æ ‡ï¼š</strong><br>
                    å¦‚æœæ­¥éª¤3æ˜¾ç¤º"ä¼šè¯æ¢å¤æˆåŠŸ"ï¼Œè¯´æ˜åˆ·æ–°åŠŸèƒ½æ­£å¸¸ï¼<br>
                    è¿™æ„å‘³ç€åœ¨ä¸»åº”ç”¨ä¸­æŒ‰F5åˆ·æ–°ä¼šè‡ªåŠ¨ä¿æŒç™»å½•çŠ¶æ€ã€‚<br><br>
                    
                    <strong>ğŸ”§ å¦‚æœæµ‹è¯•å¤±è´¥ï¼š</strong><br>
                    1. ç¡®è®¤åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:4000<br>
                    2. ç¡®è®¤å‰ç«¯ .env.local é…ç½®æ­£ç¡®<br>
                    3. é‡å¯å‰ç«¯æœåŠ¡ä»¥åŠ è½½æ–°çš„ç¯å¢ƒå˜é‡<br>
                    4. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCmd+Shift+R æˆ– Ctrl+Shift+Rï¼‰
                </div>
            `;
        };
    </script>
</body>
</html>

